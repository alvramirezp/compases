<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RitmoAventura: App Completa</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Incluir Tone.js para generar sonido r칤tmico -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.min.js"></script>
    <script>
        // Configuraci칩n de Tailwind para usar un tema m치s juvenil y la fuente Inter
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary-blue': '#4c70f5', // Se mantiene como color principal de la app
                        'accent-yellow': '#ffc107', // AMARILLO (Usado para N칰mero Inferior y acentos)
                        'emerald-main': '#10b981', // NUEVO VERDE ESMERALDA (Usado para N칰mero Superior)
                        'strong-beat': '#f54c4c',
                        'weak-beat': '#a0a0a0',
                        'medium-beat': '#f97316',
                        'tap-green': '#10b981',
                        'tap-red': '#ef4444',
                        'dark-gray-bg': '#1f2937',
                        'pending-gray': '#6b7280', // Nuevo color para el estado de carga
                        'accent-pink': '#ec4899', // Color para el latido
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        
        /* Estilos personalizados para botones de opci칩n */
        .option-button {
            transition: all 0.2s ease-in-out;
            border: 3px solid transparent;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .option-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 10px rgba(0, 0, 0, 0.15);
        }
        .option-button.correct {
            border-color: var(--tw-colors-tap-green);
            background-color: #d1fae5;
        }
        .option-button.wrong {
            border-color: var(--tw-colors-tap-red);
            background-color: #fee2e2;
        }
        
        /* Animaci칩n que se dispara en cada pulso */
        .beat-pulse {
            animation: pulse 0.15s ease-out; 
        }
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); } 
            100% { transform: scale(1); }
        }

        /* Estilo para mostrar el comp치s como fracci칩n apilada */
        .meter-fraction {
            display: inline-block;
            line-height: 1;
        }
        .meter-fraction-top {
            font-size: 1.5rem; /* 24px */
            font-weight: 900;
        }
        .meter-fraction-bottom {
            font-size: 1.5rem; /* 24px */
            font-weight: 900;
        }
        
        /* Estilo para el comp치s de ejemplo de la Receta (tama침o grande) */
        .recipe-meter-number {
            font-size: 4rem; /* 64px, mucho m치s grande */
            font-weight: 900;
            line-height: 1;
        }

        .recipe-divider {
            height: 4px; 
            background-color: #9ca3af; /* gray-400 */
            margin: 0.5rem 0; /* Margen superior/inferior para separarlo de los n칰meros */
        }
        
        /* Estilo espec칤fico para los compases en la secci칩n de acentos */
        .accent-meter-fraction {
            display: inline-block;
            line-height: 1;
            margin-bottom: 0.5rem;
        }
        .accent-meter-number {
            font-size: 2.5rem; /* M치s grande que la secci칩n de ejemplos, m치s legible */
            font-weight: 900;
        }

    </style>
</head>
<body class="bg-gray-100 font-sans min-h-screen p-4 flex items-center justify-center">

    <div id="app-container" class="w-full max-w-4xl bg-white p-6 md:p-10 rounded-xl shadow-2xl border-b-8 border-primary-blue">
        
        <!-- Encabezado y Navegaci칩n -->
        <header class="text-center mb-8">
            <h1 class="text-4xl font-black text-primary-blue mb-2">
                <span class="text-accent-yellow">游꿨</span> RitmoAventura <span class="text-accent-yellow">游꿨</span>
            </h1>
            <p class="text-gray-600 italic">춰Aprende y domina los Compases Musicales!</p>
            
            <!-- Botones de Navegaci칩n -->
            <div class="mt-6 flex justify-center space-x-4">
                <button id="navAprender" class="px-6 py-2 rounded-full font-bold text-lg transition duration-200 shadow-md bg-primary-blue text-white hover:bg-primary-blue/80">
                    游닄 Aprender
                </button>
                <button id="navJugar" class="px-6 py-2 rounded-full font-bold text-lg transition duration-200 shadow-md bg-gray-200 text-gray-800 hover:bg-accent-yellow hover:text-white">
                    游꿚 Jugar
                </button>
            </div>
        </header>

        <!-- Contenido Principal: APRENDER -->
        <section id="viewAprender">
            <h2 class="text-3xl font-bold text-gray-800 mb-6 border-b-2 pb-2 border-accent-yellow">Los compases musicales</h2>

            <div class="bg-blue-50 p-6 rounded-lg mb-6 shadow-inner border-l-4 border-primary-blue">
                <h3 class="text-xl font-bold text-primary-blue mb-3">1. La "Receta R칤tmica" (Los n칰meros del comp치s)</h3>
                
                <!-- Contenedor del Comp치s de ejemplo de la Receta -->
                <div class="flex-shrink-0 bg-white p-6 rounded-lg shadow-xl w-full">
                    
                    <!-- Contenedor Flex para el N칰mero del Comp치s y la Explicaci칩n -->
                    <div class="flex items-start space-x-6">

                        <!-- Columna de la Fracci칩n (Comp치s 4/4) -->
                        <div class="flex flex-col items-center justify-center">
                            <!-- N칰mero Superior (4) -->
                            <div class="text-center">
                                <span id="recipeNumberTop" class="recipe-meter-number text-emerald-main">4</span>
                            </div>

                            <!-- Barra divisoria (peque침a, solo debajo del n칰mero) -->
                            <div class="recipe-divider w-12 rounded-full"></div>

                            <!-- N칰mero Inferior (4) -->
                            <div class="text-center">
                                <span id="recipeNumberBottom" class="recipe-meter-number text-accent-yellow">4</span>
                            </div>
                        </div>

                        <!-- Columna de la Explicaci칩n -->
                        <div class="flex flex-col space-y-4 pt-2">
                            
                            <!-- Explicaci칩n Superior -->
                            <div class="text-gray-700 text-lg">
                                <span class="font-bold text-emerald-main">N칰mero Superior (El contador):</span> <br> 
                                Indica <span class="font-extrabold">cu치ntas figuras</span> caben en el comp치s.
                            </div>
                            
                            <!-- Explicaci칩n Inferior -->
                            <div class="text-gray-700 text-lg">
                                <span class="font-bold text-accent-yellow">N칰mero Inferior (El ingrediente):</span> <br>
                                Indica de <span class="font-extrabold">qu칠 figura musical</span> se trata. 
                                <div class="bg-yellow-100 p-3 mt-3 rounded-md border-l-4 border-accent-yellow shadow-sm text-sm">
                                    <ul class="list-disc list-inside space-y-1">
                                        <li><span class="font-mono font-bold text-gray-800">1:</span> La Redonda (dura 4 pulsos)</li>
                                        <li><span class="font-mono font-bold text-gray-800">2:</span> La Blanca (dura 2 pulsos)</li>
                                        <li><span class="font-mono font-bold text-gray-800">4:</span> La Negra (dura 1 pulso)</li>
                                        <li><span class="font-mono font-bold text-gray-800">8:</span> La Corchea (dura 1/2 pulso)</li>
                                    </ul>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>

                <!-- Nuevos Ejemplos de Compases con formato de fracci칩n -->
                <h4 class="text-lg font-bold text-primary-blue mt-6 mb-3 border-t pt-4 border-gray-200">Ejemplos de compases</h4>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    
                    <!-- Ejemplo 4/4 -->
                    <div class="p-4 bg-white rounded-lg shadow-md border-l-4 border-primary-blue text-center">
                        <div class="meter-fraction mb-4">
                            <div class="meter-fraction-top text-emerald-main">4</div>
                            <div class="h-0.5 bg-gray-400 w-10 mx-auto"></div>
                            <div class="meter-fraction-bottom text-accent-yellow">4</div>
                        </div>
                        <!-- Texto principal (conservado) -->
                        <p class="text-xl font-extrabold text-gray-800">
                            <span class="text-emerald-main">Cuatro</span> <span class="text-accent-yellow">Negras</span>
                        </p>
                    </div>
                    
                    <!-- Ejemplo 2/2 -->
                    <div class="p-4 bg-white rounded-lg shadow-md border-l-4 border-primary-blue text-center">
                        <div class="meter-fraction mb-4">
                            <div class="meter-fraction-top text-emerald-main">2</div>
                            <div class="h-0.5 bg-gray-400 w-10 mx-auto"></div>
                            <div class="meter-fraction-bottom text-accent-yellow">2</div>
                        </div>
                        <!-- Texto principal (conservado) -->
                        <p class="text-xl font-extrabold text-gray-800">
                            <span class="text-emerald-main">Dos</span> <span class="text-accent-yellow">Blancas</span>
                        </p>
                    </div>

                    <!-- Ejemplo 6/8 -->
                    <div class="p-4 bg-white rounded-lg shadow-md border-l-4 border-primary-blue text-center">
                        <div class="meter-fraction mb-4">
                            <div class="meter-fraction-top text-emerald-main">6</div>
                            <div class="h-0.5 bg-gray-400 w-10 mx-auto"></div>
                            <div class="meter-fraction-bottom text-accent-yellow">8</div>
                        </div>
                        <!-- Texto principal (conservado) -->
                        <p class="text-xl font-extrabold text-gray-800">
                            <span class="text-emerald-main">Seis</span> <span class="text-accent-yellow">Corcheas</span>
                        </p>
                    </div>

                </div>
            </div>

            <div class="bg-pink-50 p-6 rounded-lg mb-6 shadow-inner border-l-4 border-accent-pink">
                <h3 class="text-xl font-bold text-accent-pink mb-3">2. El "latido del coraz칩n musical" (Acentos)</h3>
                <p class="text-gray-700 mb-4">El ritmo tiene latidos <span class="font-extrabold">fuertes</span> (춰bum!) y <span class="font-extrabold">d칠biles</span> (tap). <br> Esto define si el comp치s es Binario, Ternario o Cuaternario.</p>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-center">
                    
                    <!-- Comp치s Binario (2/4) -->
                    <div class="p-4 bg-white rounded-lg shadow-md border-b-4 border-strong-beat">
                        <div class="accent-meter-fraction mx-auto">
                            <div class="accent-meter-number text-emerald-main">2</div>
                            <div class="h-1 bg-gray-400 w-12 mx-auto rounded-full"></div>
                            <div class="accent-meter-number text-accent-yellow">4</div>
                        </div>
                        <p class="text-xl font-black text-strong-beat mt-2">Binario</p>
                        <p class="text-gray-600">bum tap</p>
                    </div>
                    
                    <!-- Comp치s Ternario (3/4) -->
                    <div class="p-4 bg-white rounded-lg shadow-md border-b-4 border-strong-beat">
                        <div class="accent-meter-fraction mx-auto">
                            <div class="accent-meter-number text-emerald-main">3</div>
                            <div class="h-1 bg-gray-400 w-12 mx-auto rounded-full"></div>
                            <div class="accent-meter-number text-accent-yellow">4</div>
                        </div>
                        <p class="text-xl font-black text-strong-beat mt-2">Ternario</p>
                        <p class="text-gray-600">bum tap tap</p>
                    </div>
                    
                    <!-- Comp치s Cuaternario (4/4) -->
                    <div class="p-4 bg-white rounded-lg shadow-md border-b-4 border-strong-beat">
                        <div class="accent-meter-fraction mx-auto">
                            <div class="accent-meter-number text-emerald-main">4</div>
                            <div class="h-1 bg-gray-400 w-12 mx-auto rounded-full"></div>
                            <div class="accent-meter-number text-accent-yellow">4</div>
                        </div>
                        <p class="text-xl font-black text-strong-beat mt-2">Cuaternario</p>
                        <p class="text-gray-600">bum tap tap tap</p>
                    </div>
                </div>
            </div>
            
            <div class="bg-yellow-50 p-6 rounded-lg shadow-inner border-l-4 border-accent-yellow">
                <h3 class="text-xl font-bold text-accent-yellow mb-3">3. Las Figuras Musicales</h3>
                <p class="text-gray-700">Las figuras musicales definen el <span class="font-extrabold">ritmo</span> de la obra musical. Nos indican <span class="font-extrabold">cu치nto dura</span> cada sonido (o silencio).</p>
                <p class="text-gray-700"> Para repasar las figuras musicales, sus silencios y su duraci칩n, utiliza la aplicaci칩n <span class="font-extrabold">Ritmo y Melod칤a</span>.</p>

            </div>
        </section>


        <!-- Contenido Principal: JUGAR (DESAF칈O AUDITIVO) -->
        <section id="viewJugar" class="hidden">
            <h2 class="text-3xl font-bold text-gray-800 mb-6 border-b-2 pb-2 border-accent-yellow">游꿚 Desaf칤o Auditivo: Identifica el Comp치s</h2>
            
            <!-- Panel de Control y Marcador -->
            <div class="flex justify-between items-center bg-dark-gray-bg text-white p-4 rounded-t-xl">
                <!-- Puntuaci칩n (10 puntos por acierto) -->
                <div class="text-lg font-bold">Puntuaci칩n: <span id="gameScore" class="text-green-400">0 / 100</span></div>
                <!-- Ronda / Nivel de dificultad -->
                <div class="text-lg font-bold">Ronda: <span id="gameLevel" class="text-accent-yellow">1 / 10</span></div>
                <!-- Velocidad Actual (Dificultad Progresiva) -->
                <div class="text-lg font-bold">Velocidad: <span id="currentBPMDisplay" class="text-accent-yellow">120</span> BPM</div> 
            </div>

            <!-- 츼rea de Metr칩nomo y Bot칩n de Reproducci칩n -->
            <div class="bg-gray-100 p-8 rounded-b-xl shadow-inner mb-6 text-center">
                
                <p class="text-gray-600 text-sm mb-4">Haz clic para escuchar el patr칩n de acentos. Elige la opci칩n que coincida.</p>

                <!-- Display Visual del Comp치s (Se oculta en rondas dif칤ciles) -->
                <div id="beatVisualizer" class="flex justify-center items-center h-20 mb-6">
                    <span id="visualBeat" class="text-6xl font-black text-gray-400">?</span>
                </div>
                
                <button id="playButton" class="px-10 py-4 bg-primary-blue text-white text-xl font-bold rounded-lg shadow-lg hover:bg-primary-blue/90 transition duration-150" disabled>
                    游댉 Escuchar Comp치s (BPM 120)
                </button>
            </div>

            <!-- Opciones de Respuesta -->
            <div class="text-center">
                <p class="text-xl font-bold text-gray-800 mb-4">쯈u칠 tipo de comp치s acabas de escuchar?</p>
                <div id="answerOptions" class="grid grid-cols-3 gap-4">
                    <button class="option-button p-4 rounded-lg bg-white font-bold text-lg text-gray-800" data-answer="Binario">
                        Binario (2/4)
                    </button>
                    <button class="option-button p-4 rounded-lg bg-white font-bold text-lg text-gray-800" data-answer="Ternario">
                        Ternario (3/4)
                    </button>
                    <button class="option-button p-4 rounded-lg bg-white font-bold text-lg text-gray-800" data-answer="Cuaternario">
                        Cuaternario (4/4)
                    </button>
                </div>
            </div>

            <!-- Mensajes y Overlay de Fin de Juego -->
            <div id="messageBox" class="mt-6 text-center text-xl font-bold h-8 text-gray-700"></div>

            <div id="gameOverModal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center hidden z-50">
                <div class="bg-white p-8 rounded-xl text-center shadow-2xl transform transition-all duration-300 scale-95">
                    <h3 class="text-4xl font-black text-primary-blue mb-4">춰FIN DEL DESAF칈O! 游봅</h3>
                    <p class="text-xl text-gray-700 mb-6">Conseguiste identificar <span id="finalScore" class="text-accent-yellow font-extrabold text-3xl">0 / 100</span> puntos</p>
                    <button id="restartGame" class="px-8 py-3 bg-green-500 text-white font-bold rounded-lg shadow-lg hover:bg-green-600 transition duration-150">
                        Volver a Empezar
                    </button>
                </div>
            </div>

        </section>

    </div>

    <script type="text/javascript">
        // Variables Globales de Vistas y Elementos DOM
        let currentView = 'aprender';
        const views = {
            aprender: document.getElementById('viewAprender'),
            jugar: document.getElementById('viewJugar')
        };
        const navButtons = {
            aprender: document.getElementById('navAprender'),
            jugar: document.getElementById('navJugar')
        };
        
        // --- L칩gica del Juego ---
        const playButton = document.getElementById('playButton');
        const visualBeatElement = document.getElementById('visualBeat');
        const answerOptions = document.getElementById('answerOptions');
        const messageBox = document.getElementById('messageBox');
        const gameOverModal = document.getElementById('gameOverModal');
        
        let score = 0;
        let level = 1; // Contador de rondas (1 to 10)
        const MAX_ROUNDS = 10;
        const POINTS_PER_ROUND = 10;
        let currentBPM = 120; // Velocidad actual
        let showVisuals = true; // Controla si se muestra el n칰mero de pulso.

        let currentChallenge = {}; // Contiene el comp치s (p.ej., '4/4') y el tipo ('Cuaternario')
        let isPlaying = false;
        let isAudioInitialized = false; // Bandera para controlar la inicializaci칩n de Tone.js
        const lastChallenges = []; // Para almacenar los tipos de comp치s recientes y mejorar la aleatoriedad
        
        // --- Configuraci칩n de Audio (Metr칩nomo) ---
        let loop = null;
        let strongSynth = null; // Sintetizador para tiempos FUERTES (Acento)
        let weakSynth = null;  // Sintetizador para tiempos D칄BILES y MEDIOS (Pulsos suaves)

        // Definici칩n de los compases: TIPO -> Fracci칩n -> [Accent Level: 1=Fuerte, 0.5=Medio, 0=D칠bil]
        const METERS_DATA = {
            'Binario': {
                '2/4': [1, 0], 
                // A침adido 2/2 - es Binario, pero la unidad de tiempo es la Blanca (2)
                '2/2': [1, 0] 
            },
            'Ternario': {
                '3/4': [1, 0, 0] 
            },
            'Cuaternario': {
                '4/4': [1, 0, 0.5, 0] 
            },
            // A침adido 6/8 como Compuesto. Se clasifica como Binario en el desaf칤o auditivo (2 pulsos de 3 corcheas)
            'Compuesto': {
                // Este patr칩n de 6 corcheas se toca con 2 pulsos fuertes (en 1 y 4) en un tempo r치pido (Binario)
                '6/8': [1, 0, 0, 0.5, 0, 0] 
            }
        };

        // Modificamos el MAPEO para el desaf칤o auditivo para simplificar a los 3 tipos de acento.
        const GAME_METERS = {
            'Binario': { '2/4': [1, 0], '2/2': [1, 0] },
            'Ternario': { '3/4': [1, 0, 0] },
            'Cuaternario': { '4/4': [1, 0, 0.5, 0] }
        };
        
        // Funci칩n para inicializar el audio, llamada al primer clic del usuario en Jugar
        async function setupAudio() {
            if (isAudioInitialized) return;

            // Deshabilitar el bot칩n y mostrar mensaje de carga
            playButton.disabled = true;
            playButton.textContent = 'Cargando Sonidos de Metr칩nomo...'; 
            
            // Iniciar el contexto de audio
            try {
                await Tone.start();
            } catch (error) {
                console.error("Error al iniciar el contexto de audio:", error);
                playButton.textContent = 'Error: Fallo al iniciar audio.';
                return;
            }
            
            // 1. Synth para tiempos FUERTES (M치s alto y pitch m치s agudo)
            strongSynth = new Tone.MembraneSynth({
                pitchDecay: 0.05,
                octaves: 2, 
                volume: -6, // Fuerte
                envelope: {
                    attack: 0.001, decay: 0.1, sustain: 0.0, release: 0.05, attackCurve: 'exponential'
                }
            }).toDestination();
            
            // 2. Synth para tiempos D칄BILES y MEDIOS (M치s suave y pitch m치s grave)
            weakSynth = new Tone.MembraneSynth({
                pitchDecay: 0.03,
                octaves: 1, 
                volume: -10, // Suave
                envelope: {
                    attack: 0.001, decay: 0.07, sustain: 0.0, release: 0.03, attackCurve: 'exponential'
                }
            }).toDestination();
            
            isAudioInitialized = true;
            playButton.disabled = false;
            updateUI();
            startGame(); // Inicia el juego autom치ticamente despu칠s de la carga
        }

        /**
         * Reproduce el patr칩n r칤tmico. 
         * Ahora toma el comp치s del estado global `currentChallenge`
         */
        function playChallenge() {
            if (isPlaying || !isAudioInitialized || !currentChallenge.pattern) return;
            
            isPlaying = true;
            playButton.disabled = true;
            
            const { pattern, type } = currentChallenge;
            
            // L칍GICA DE REPETICI칍N MEJORADA: 
            const measuresToPlay = 2; 
            const stopTime = `${measuresToPlay}m`; 

            // Detener y limpiar cualquier loop previo y el Transport
            if (loop) loop.dispose();
            Tone.Transport.stop(); 
            Tone.Transport.cancel(); 
            loop = null; 
            
            // Reset visual inicial (solo el fondo, el n칰mero se pone con el primer beat)
            if (showVisuals) {
                visualBeatElement.style.opacity = '1'; 
                visualBeatElement.textContent = '?';
                visualBeatElement.className = 'text-6xl font-black text-pending-gray'; 
            } else {
                visualBeatElement.style.opacity = '0';
                visualBeatElement.textContent = '游꿨'; 
            }
            
            Tone.Transport.bpm.value = currentBPM; 
            
            const beatsPerMeasure = pattern.length;
            let currentBeatIndex = 0; 
            
            // 1. Programar el loop para tocar
            loop = new Tone.Loop(function (time) {
                
                const beatIndexInMeasure = currentBeatIndex % beatsPerMeasure; 
                const accent = pattern[beatIndexInMeasure];
                
                let currentSynth = weakSynth;
                let note = "C4"; 
                let velocity = 0.8; 

                // Determinar el sonido y acento
                if (accent === 1) { // Fuerte
                    currentSynth = strongSynth;
                    note = "G4"; 
                    velocity = 1.0; 
                } else if (accent === 0.5) { // Medio Fuerte (solo en 4/4)
                    currentSynth = weakSynth;
                    note = "C4"; 
                    velocity = 0.9;
                } else { // D칠bil (0)
                    currentSynth = weakSynth;
                    note = "C4"; 
                    velocity = 0.8; 
                }

                currentSynth.triggerAttackRelease(note, "16n", time, velocity);

                // --- L칩gica de Actualizaci칩n Visual sincronizada con el audio ---
                if (showVisuals) {
                    Tone.Draw.schedule(function () {
                        const visualIndex = beatIndexInMeasure + 1; 
                        
                        let colorClass = 'text-weak-beat';
                        if (accent === 1) colorClass = 'text-strong-beat';
                        else if (accent === 0.5) colorClass = 'text-medium-beat';
                        
                        // 1. Limpiar la clase de animaci칩n para que se reinicie
                        visualBeatElement.classList.remove('beat-pulse');
                        
                        // 2. Actualizar el n칰mero y las clases de color
                        visualBeatElement.textContent = visualIndex;
                        visualBeatElement.classList.remove('text-strong-beat', 'text-medium-beat', 'text-weak-beat', 'text-pending-gray');
                        visualBeatElement.classList.add(colorClass);

                        // 3. Forzar un reflow/repaint ANTES de a침adir la clase de animaci칩n (CR칈TICO)
                        void visualBeatElement.offsetWidth; 

                        // 4. Aplicar la clase de animaci칩n para disparar el pulso visible
                        visualBeatElement.classList.add('beat-pulse');
                        visualBeatElement.style.opacity = '1';
                        
                    }, time);
                }

                currentBeatIndex++; 
                
            }, '4n').start(0); 
            
            // 2. Programar el stop del transport y el reset de la UI al final del tiempo musical
            Tone.Transport.scheduleOnce(() => {
                Tone.Transport.stop();
                isPlaying = false; 
                playButton.disabled = false;
                
                if (loop) { 
                    loop.dispose(); 
                    loop = null;
                }
                
                // Reset visual final (Vuelta al estado de espera)
                if (showVisuals) {
                    visualBeatElement.textContent = '?';
                    visualBeatElement.classList.remove('text-strong-beat', 'text-medium-beat', 'text-weak-beat', 'beat-pulse');
                    visualBeatElement.classList.add('text-pending-gray');
                    visualBeatElement.style.opacity = '1'; 
                } else {
                    visualBeatElement.textContent = '游꿨'; 
                    visualBeatElement.style.opacity = '0';
                }

            }, stopTime); 
            
            Tone.Transport.start(); // Inicia el Transport
        }

        // --- Funciones de Juego ---

        function updateUI() {
            document.getElementById('gameScore').textContent = `${score} / 100`;
            document.getElementById('gameLevel').textContent = `${level} / ${MAX_ROUNDS}`;
            
            if (currentView === 'jugar' && isAudioInitialized) {
                document.getElementById('currentBPMDisplay').textContent = currentBPM;
                playButton.textContent = `游댉 Escuchar Comp치s (BPM ${currentBPM})`;
            }
        }

        function showMessage(text, isError = false) {
            messageBox.textContent = text;
            messageBox.className = `mt-6 text-center text-xl font-bold h-8 transition-colors duration-200 ${isError ? 'text-tap-red beat-pulse' : 'text-tap-green beat-pulse'}`;
            setTimeout(() => {
                messageBox.textContent = '';
                messageBox.classList.remove('beat-pulse');
            }, 3000);
        }

        /**
         * Selecciona un nuevo desaf칤o, actualiza la dificultad y el estado de la UI.
         */
        function selectNewChallenge() {
            // Deshabilitar bot칩n mientras se carga el desaf칤o (para evitar el error reportado)
            playButton.disabled = true;
            playButton.textContent = 'Cargando nuevo desaf칤o...'; 

            // 1. Dificultad Progresiva: Actualizar BPM y Visuales
            if (level <= 4) {
                currentBPM = 100; // Lento, Visuales ON
                showVisuals = true;
            } else if (level <= 7) {
                currentBPM = 120; // Medio, Visuales OFF (Dificultad media)
                showVisuals = false;
            } else { // Rondas 8-10
                currentBPM = 140; // R치pido, Visuales OFF (Dificultad alta)
                showVisuals = false;
            }
            
            // 2. Selecci칩n Aleatoria de Comp치s
            // Usamos solo los tipos de acento Binario, Ternario, Cuaternario para el desaf칤o
            const allTypes = Object.keys(GAME_METERS);
            const availableTypes = allTypes.filter(type => !lastChallenges.includes(type));
            let randomType;
            if (availableTypes.length > 0) {
                randomType = availableTypes[Math.floor(Math.random() * availableTypes.length)];
            } else {
                randomType = allTypes[Math.floor(Math.random() * allTypes.length)];
            }
            
            lastChallenges.push(randomType);
            if (lastChallenges.length > 2) {
                lastChallenges.shift();
            }
            
            const fractions = Object.keys(GAME_METERS[randomType]);
            const randomFraction = fractions[Math.floor(Math.random() * fractions.length)];
            
            currentChallenge = {
                type: randomType,
                fraction: randomFraction,
                pattern: GAME_METERS[randomType][randomFraction]
            };
            
            // 3. Limpiar y Habilitar UI
            Array.from(answerOptions.children).forEach(btn => {
                btn.classList.remove('correct', 'wrong');
                btn.disabled = false;
            });
            
            // Aplicar estado visual inicial del metr칩nomo
            if (showVisuals) {
                visualBeatElement.style.opacity = '1';
                visualBeatElement.textContent = '?';
                // Usar 'pending-gray' para la interrogaci칩n de espera
                visualBeatElement.classList.remove('text-strong-beat', 'text-medium-beat', 'text-weak-beat');
                visualBeatElement.classList.add('text-pending-gray'); 
            } else {
                visualBeatElement.style.opacity = '0';
                visualBeatElement.textContent = '游꿨'; 
            }

            updateUI();
            
            // Habilitar el bot칩n de reproducir solo cuando el desaf칤o est치 cargado
            if (isAudioInitialized) {
                playButton.disabled = false;
                playButton.textContent = `游댉 Escuchar Comp치s (BPM ${currentBPM})`;
            }
        }

        /**
         * Verifica la respuesta del usuario.
         */
        function checkAnswer(selectedType) {
            // Previene responder antes de que termine el audio
            if (isPlaying) {
                showMessage('Espera a que termine de sonar el comp치s para responder.', true);
                return;
            }

            // Deshabilitamos el bot칩n de reproducir para evitar el bug de audio desincronizado
            playButton.disabled = true;
            
            const correctType = currentChallenge.type;
            const allButtons = Array.from(answerOptions.children);
            
            // Deshabilitar botones de respuesta
            allButtons.forEach(btn => btn.disabled = true);
            
            // Marcar respuesta visualmente
            allButtons.forEach(btn => {
                const answer = btn.getAttribute('data-answer');
                if (answer === correctType) {
                    btn.classList.add('correct');
                } else if (answer === selectedType) {
                    btn.classList.add('wrong');
                }
            });

            if (selectedType === correctType) {
                score += POINTS_PER_ROUND; 
                showMessage(`춰CORRECTO! 游봅 Es un comp치s ${correctType} (${currentChallenge.fraction}).`, false);
            } else {
                showMessage(`INCORRECTO. 游 Era un comp치s ${correctType} (${currentChallenge.fraction}).`, true);
            }
            
            level++; 
            updateUI();
            
            if (level > MAX_ROUNDS) {
                document.getElementById('finalScore').textContent = `${score} / 100`;
                setTimeout(endGame, 3500); 
            } else {
                // Siguiente ronda: el timeout mantiene el feedback en pantalla
                setTimeout(() => {
                    selectNewChallenge(); // Aqu칤 se re-habilita el playButton
                }, 3500);
            }
        }

        // --- Control de Estado del Juego ---

        function startGame() {
            score = 0;
            level = 1;
            lastChallenges.length = 0; 
            
            updateUI();
            gameOverModal.classList.add('hidden');
            selectNewChallenge(); // Primera llamada para cargar el desaf칤o

            // Asignar listeners (asegurar que solo se asignen una vez)
            if (!answerOptions.getAttribute('data-listeners-set')) {
                answerOptions.onclick = (e) => {
                    const button = e.target.closest('.option-button');
                    if (button && !button.disabled) {
                        checkAnswer(button.getAttribute('data-answer'));
                    }
                };
                playButton.onclick = () => {
                    if (!isPlaying && !playButton.disabled && isAudioInitialized) {
                        playChallenge();
                    } else if (isPlaying) {
                        showMessage('El metr칩nomo est치 sonando. Espera a que termine.', false);
                    }
                };
                answerOptions.setAttribute('data-listeners-set', 'true');
            }
        }

        function endGame() {
            gameOverModal.classList.remove('hidden');
        }

        // --- Inicializaci칩n y Navegaci칩n ---
        function switchView(viewName) {
            currentView = viewName;
            
            Object.values(views).forEach(v => v.classList.add('hidden'));
            views[viewName].classList.remove('hidden');
            
            Object.entries(navButtons).forEach(([key, button]) => {
                if (key === viewName) {
                    button.classList.remove('bg-gray-200', 'text-gray-800', 'hover:bg-accent-yellow', 'hover:text-white');
                    button.classList.add('bg-primary-blue', 'text-white', 'hover:bg-primary-blue/80');
                } else {
                    button.classList.remove('bg-primary-blue', 'text-white', 'hover:bg-primary-blue/80');
                    button.classList.add('bg-gray-200', 'text-gray-800', 'hover:bg-accent-yellow', 'hover:text-white');
                }
            });
            // Detener el transporte de audio al salir de la vista de juego
            if (Tone.Transport && Tone.Transport.state === 'started') {
                 Tone.Transport.stop();
                 isPlaying = false;
                 // Intentar limpiar el loop si existe
                 if (loop) { 
                    loop.dispose(); 
                    loop = null;
                 }
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            switchView('aprender'); 
            
            // Listener para la navegaci칩n a Jugar (INICIALIZA AUDIO y llama a startGame)
            navButtons.jugar.addEventListener('click', () => {
                switchView('jugar');
                if (!isAudioInitialized) {
                    setupAudio(); 
                } else {
                    startGame();
                }
            });
            
            // Asignar listeners de navegaci칩n
            navButtons.aprender.addEventListener('click', () => {
                switchView('aprender');
            });
            
            // Listener para reiniciar el juego
            document.getElementById('restartGame').addEventListener('click', restartGame);
            
            // Estado inicial del bot칩n de reproducci칩n antes de la interacci칩n de usuario
            playButton.disabled = true;
            playButton.textContent = 'Esperando interacci칩n para cargar audio...';
        });

        // Aseguramos que la funci칩n restartGame est칠 disponible
        function restartGame() {
            // Aseguramos que el metr칩nomo est칠 detenido
            if (Tone.Transport && Tone.Transport.state === 'started') {
                 Tone.Transport.stop();
                 isPlaying = false;
                 if (loop) { 
                    loop.dispose(); 
                    loop = null;
                 }
            }
            startGame();
        }
    </script>
</body>
</html>